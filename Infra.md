# Infra 설명

## 요구사항
1. **필수 요구사항**
- [x] 애플리케이션을 AWS에 배포 가능한 상태로 구축해야 한다.
- [x] 애플리케이션 서버와 데이터베이스 서버를 물리·네트워크 계층에서 분리해야 한다.
- [x] 개발(dev)과 운영(prod)의 설정을 서로 독립적으로 관리·배포해야 한다.
2. **추가 요구사항(선택)**
- [x] 소스 변경 시 자동 빌드·배포가 수행되도록 파이프라인을 구성해야 한다.
- [x] 개인 도메인을 애플리케이션에 연결하고 HTTPS를 적용해야 한다.
- [ ] 애플리케이션 로그를 파일 또는 수집기로 영속화하고 조회 절차를 제공해야 한다.
- [ ] 서버 자원(CPU·메모리·네트워크 등)을 지표·대시보드로 시각화해야 한다.
- [ ] 운영 중 스키마 변경 시 데이터 보존 상태로 마이그레이션 및 재배포를 완료해야 한다.
- [ ] 제공 API의 문서 명세를 작성·공개해야 한다.
- [ ] 전체 인프라를 다이어그램으로 작성하고 각 구성요소 역할을 설명해야 한다.

## 관련 URL
### 개발 서버
https://gakong-dev.o-r.kr/cakes

### 운영 서버
https://gakong.woowacourse.com/cakes

### workflow script
[dev-workflow](https://github.com/gabean13/lv3-final-mission/blob/my-feature/.github/workflows/dev-cicd-workflow.yml)
[prod-workflow](https://github.com/gabean13/lv3-final-mission/blob/my-feature/.github/workflows/prod-cicd-workflow.yml)


## 설명
개발 서버와 운영 서버 그리고 DB 서버를 물리적으로 분리하였습니다. 
단일 서버에 개발, 운영, DB가 있으면 서버가 장애가 발생했을 때, 모든 서비스가 다운된다는 문제를 방지하고자했습니다.
또 개발 서버는 빈번하게 변경이 일어나기 때문에 운영 서버와 물리적으로 분리하여 운영 환경의 안정성을 높이고자 했습니다.
DB는 가장 중요한 데이터이므로 애플리케이션의 영향을 받지 않는 아예 외부의 공간으로 분리하여 최대한 가용성을 확보하고자 했습니다.

수동 배포를 하지 않고, 정확하고 빠르게 배포하기 위해, develop(개발), release(운영) branch에 push시 github action으로 테스트 & 빌드 및 자동 배포를 합니다.
이때, 현재 ec2의 인바운드 규칙으로 22번 포트에 특정 ip가 아니면 접근할 수 없기 때문에 self hosted runner를 사용하였습니다.
아웃바운드 규칙은 없기 때문에 hosted runner가 github action에 지속적으로 요청을 보내고(60s 이내로 장기 polling을 반복적으로 보냄) 대기중인 job이 발견되면 hosted runner가 빌드 된 아티펙트를 가져와서 
실행시킵니다. 
polling을 해야하기 때문에 메모리 부담이 있을 수 있으나 runner의 메모리는 평균적으로 120mb정도 사용하므로 현재 서버에서는 큰 무리가 없겠다고 판단했습니다.
다만, 현재 배포마다 8s정도 다운타임이 있기 때문에 추후 무중단 배포를 도입해야할 것 같습니다. 

HTTP로 통신하기 때문에 중간에 패킷 탈취 등을 막기위해 HTTPS를 도입했습니다.
개발 서버와 운영 서버 모두 적용하였고, certbot을 사용하여 인증서 만료 시 자동 갱신하도록 하여 이후 추가적인 작업을 하지 않아도 되도록 하였습니다.
앞에 nginx를 리버스 프록시로 두어서 nginx가 443, 80요청을 내부 스프링 프로세스인 8080으로 보내도록 하였습니다.
